<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../favicon.ico">
    <link rel="stylesheet" href="../styles/bootstrap.css">
    <link rel="stylesheet" href="../styles/bootstrap-override.css">
    <link rel="stylesheet" href="../styles/styles.css">
    <title>–ö–∞—Ç–∞–ª–æ–≥ —Å—Ç–∏—Ö–æ–≤ ‚Äî –°–±–æ—Ä–Ω–∏–∫ —Å—Ç–∏—Ö–æ–≤</title>
    <script src="../scripts/theme.js"></script>
    <script src="../scripts/bootstrap.bundle.js"></script>
    <script src="../scripts/jquery-3.7.1.min.js"></script>
    <script src="../scripts/poems-manager.js"></script>
    <script src="../scripts/favorites.js"></script>
    <script src="../scripts/load-components.js"></script>
</head>
<body>
    <!-- Page Loader -->
    <div id="page-loader">
        <div class="loader-spinner"></div>
    </div>

    <div id="header-placeholder"></div>

    <main>
        <section class="poems-catalog py-5">
            <div class="container">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="row mb-4">
                    <div class="col-12 text-center">
                        <h1 class="display-heading fw-bold mb-3">–ö–∞—Ç–∞–ª–æ–≥ —Å—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–π</h1>
                        <p class="lead-text" id="poemsCount">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                    </div>
                </div>

                <!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
                <div class="row mb-4">
                    <div class="col-12 col-lg-8 mx-auto">
                        <div class="input-group mb-3">
                            <input type="text" id="searchInput" class="form-control" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∞–≤—Ç–æ—Ä—É, —Ç–µ–∫—Å—Ç—É...">
                            <button class="btn btn-main" type="button" id="searchBtn">
                                <span>üîç</span> –ò—Å–∫–∞—Ç—å
                            </button>
                        </div>
                        
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <select id="moodFilter" class="form-select" style="width: auto;">
                                <option value="">–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è</option>
                            </select>
                            <select id="sortBy" class="form-select" style="width: auto;">
                                <option value="title">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
                                <option value="author">–ü–æ –∞–≤—Ç–æ—Ä—É</option>
                                <option value="year">–ü–æ –≥–æ–¥—É (—Å—Ç–∞—Ä—ã–µ)</option>
                                <option value="yearDesc">–ü–æ –≥–æ–¥—É (–Ω–æ–≤—ã–µ)</option>
                            </select>
                            <button class="btn btn-outline-secondary" id="resetBtn">–°–±—Ä–æ—Å–∏—Ç—å</button>
                        </div>

                        <!-- –¢–µ–≥–∏ -->
                        <div id="tagsContainer" class="d-flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <!-- –°–ø–∏—Å–æ–∫ —Å—Ç–∏—Ö–æ–≤ -->
                <div class="row g-4" id="poemsGrid">
                    <div class="col-12 text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="footer-placeholder"></div>

    <script>
        let currentPoems = [];
        let selectedTags = [];

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ —Å—Ç–∏—Ö–æ–≤
        function renderPoems(poems) {
            const grid = document.getElementById('poemsGrid');
            
            if (poems.length === 0) {
                grid.innerHTML = `
                    <div class="col-12 text-center">
                        <p class="text-muted">–°—Ç–∏—Ö–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã üòî</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = poems.map(poem => {
                const isFavorite = favoritesManager.isPoemFavorite(poem.id);
                return `
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="poem-card" data-poem-id="${poem.id}">
                        <div class="poem-card-header">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h3 class="poem-card-title">${poem.title}</h3>
                                    <p class="poem-card-author">${poem.author}</p>
                                    ${poem.year ? `<span class="poem-card-year">${poem.year}</span>` : ''}
                                </div>
                                <button class="btn btn-sm btn-link favorite-toggle-btn ${isFavorite ? 'text-danger' : 'text-secondary'}" 
                                        data-poem-id="${poem.id}" 
                                        title="${isFavorite ? '–£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'}">
                                    ${isFavorite ? '‚ù§Ô∏è' : 'ü§ç'}
                                </button>
                            </div>
                        </div>
                        <div class="poem-card-body">
                            <p class="poem-card-preview">${poem.text.substring(0, 150)}...</p>
                        </div>
                        <div class="poem-card-footer">
                            <div class="poem-tags">
                                ${poem.tags.map(tag => `<span class="badge bg-secondary">${tag}</span>`).join(' ')}
                            </div>
                            <button class="btn btn-sm btn-main read-poem-btn" data-poem-id="${poem.id}">
                                –ß–∏—Ç–∞—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–ß–∏—Ç–∞—Ç—å"
            document.querySelectorAll('.read-poem-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const poemId = parseInt(e.target.dataset.poemId);
                    showPoemModal(poemId);
                });
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
            document.querySelectorAll('.favorite-toggle-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const poemId = parseInt(e.target.dataset.poemId);
                    const isFavorite = favoritesManager.togglePoem(poemId);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –∏ —Ü–≤–µ—Ç
                    e.target.textContent = isFavorite ? '‚ù§Ô∏è' : 'ü§ç';
                    e.target.className = `btn btn-sm btn-link favorite-toggle-btn ${isFavorite ? 'text-danger' : 'text-secondary'}`;
                    e.target.title = isFavorite ? '–£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ';
                });
            });
        }

        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (—Å–æ–∑–¥–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑)
        let poemModalInstance = null;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –≤—Å–µ—Ö backdrop'–æ–≤ (–Ω–∞ —Å–ª—É—á–∞–π –±–∞–≥–æ–≤)
        function cleanupBackdrops() {
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è backdrop'—ã
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                backdrop.remove();
            });
            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º body
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ —Å—Ç–∏—Ö–æ–º
        function showPoemModal(poemId) {
            const poem = poemsManager.getPoemById(poemId);
            if (!poem) return;

            // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
            let modal = document.getElementById('poemModal');
            if (!modal) {
                const modalHTML = `
                    <div class="modal fade" id="poemModal" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="poemModalTitle"></h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p class="text-muted" id="poemModalAuthor"></p>
                                    <div id="poemModalText" style="white-space: pre-line; line-height: 1.8;"></div>
                                    <div id="poemModalTags" class="mt-3"></div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                modal = document.getElementById('poemModal');
                
                // –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ–¥–∏–Ω —Ä–∞–∑
                poemModalInstance = new bootstrap.Modal(modal);

                // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ —Å–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏
                modal.addEventListener('hidden.bs.modal', cleanupBackdrops);
            }

            // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–º–∏
            document.getElementById('poemModalTitle').textContent = poem.title;
            document.getElementById('poemModalAuthor').textContent = `${poem.author}, ${poem.year || '–≥–æ–¥ –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}`;
            document.getElementById('poemModalText').textContent = poem.text;
            document.getElementById('poemModalTags').innerHTML = poem.tags.map(tag => 
                `<span class="badge bg-secondary me-1">${tag}</span>`
            ).join('');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º (–∏—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä)
            poemModalInstance.show();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Ç–µ–≥–æ–≤
        function renderTags() {
            const tags = poemsManager.getAllTags();
            const container = document.getElementById('tagsContainer');
            
            container.innerHTML = tags.map(tag => {
                const isActive = selectedTags.includes(tag);
                return `
                    <button class="btn btn-sm ${isActive ? 'btn-main' : 'btn-outline-secondary'} tag-btn" 
                            data-tag="${tag}">
                        ${tag}
                    </button>
                `;
            }).join('');

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ç–µ–≥–æ–≤
            document.querySelectorAll('.tag-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tag = e.target.dataset.tag;
                    if (selectedTags.includes(tag)) {
                        selectedTags = selectedTags.filter(t => t !== tag);
                    } else {
                        selectedTags.push(tag);
                    }
                    applyFilters();
                });
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π
        function renderMoodFilter() {
            const moods = poemsManager.getAllMoods();
            const select = document.getElementById('moodFilter');
            
            moods.forEach(mood => {
                const option = document.createElement('option');
                option.value = mood;
                option.textContent = mood;
                select.appendChild(option);
            });
        }

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function applyFilters() {
            let poems = poemsManager.getAllPoems();

            // –ü–æ–∏—Å–∫
            const searchQuery = document.getElementById('searchInput').value;
            if (searchQuery) {
                poems = poemsManager.searchPoems(searchQuery);
            }

            // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥–∞–º
            if (selectedTags.length > 0) {
                poems = poemsManager.filterByTags(selectedTags);
            }

            // –§–∏–ª—å—Ç—Ä –ø–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—é
            const mood = document.getElementById('moodFilter').value;
            if (mood) {
                poems = poemsManager.filterByMood(mood);
            }

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
            const sortBy = document.getElementById('sortBy').value;
            poems = poemsManager.sortPoems(poems, sortBy);

            currentPoems = poems;
            renderPoems(poems);
            renderTags(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–µ–≥–∏ —Å —É—á–µ—Ç–æ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        document.addEventListener('poemsDataLoaded', () => {
            currentPoems = poemsManager.getAllPoems();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
            document.getElementById('poemsCount').textContent = 
                `–í –∫–æ–ª–ª–µ–∫—Ü–∏–∏ ${currentPoems.length} —Å—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–π –æ—Ç ${poemsManager.getAllPoets().length} –ø–æ—ç—Ç–æ–≤`;

            // –†–µ–Ω–¥–µ—Ä–∏–º –≤—Å–µ
            renderPoems(currentPoems);
            renderTags();
            renderMoodFilter();

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            document.getElementById('searchBtn').addEventListener('click', applyFilters);
            document.getElementById('searchInput').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') applyFilters();
            });
            document.getElementById('moodFilter').addEventListener('change', applyFilters);
            document.getElementById('sortBy').addEventListener('change', applyFilters);
            document.getElementById('resetBtn').addEventListener('click', () => {
                document.getElementById('searchInput').value = '';
                document.getElementById('moodFilter').value = '';
                document.getElementById('sortBy').value = 'title';
                selectedTags = [];
                applyFilters();
            });
        });
    </script>

    <style>
        .poem-card {
            background: var(--bg-primary);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 12px;
            padding: 1.5rem;
            height: 100%;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        [data-theme="dark"] .poem-card {
            border-color: rgba(255,255,255,0.1);
        }

        .poem-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .poem-card-header {
            margin-bottom: 1rem;
        }

        .poem-card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .poem-card-author {
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: 0.25rem;
        }

        .poem-card-year {
            font-size: 0.875rem;
            color: var(--accent);
            font-weight: 500;
        }

        .poem-card-body {
            flex-grow: 1;
            margin-bottom: 1rem;
        }

        .poem-card-preview {
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .poem-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .poem-tags {
            flex-grow: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        .poem-tags .badge {
            font-size: 0.75rem;
        }
    </style>
</body>
</html>
